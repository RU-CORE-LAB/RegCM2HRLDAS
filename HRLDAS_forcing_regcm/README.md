# RegCM → HRLDAS Forcing Generator  
### LDASIN Generator from RegCM2HRLDAS Output  
*(Post-processing module after the Toolchain Installer)*

**Developed by:** RU-CORE  
**Author:** Ratchanan Srisawadwong (Nick)

***Original Script Credits***

This module is adapted from the original ERA5-based HRLDAS preprocessing workflow developed by:

***DOAN Quang Van and XUE Lingbo***
Center for Computational Sciences (CCS)
University of Tsukuba, Japan.

https://github.com/xuelingbo/LSP-DS.git

Their original work focused on:

- Automated ERA5 data downloading
- Atmospheric preprocessing
- Geopotential computation on model levels
- Generation of HRLDAS setup and LDASIN forcing files
This RegCM-based version extends that framework to support regional climate model outputs and long-term climate simulations.
---
This module operates **after** the **RegCM → HRLDAS Toolchain Installer**.

It uses RegCM outputs that have already undergone:

- Atmospheric vertical level conversion  
- Variable formatting and unit standardization  
- Surface and soil data preparation  

to generate **HRLDAS LDASIN forcing files** and supporting input files required to run  
**HRLDAS (High Resolution Land Data Assimilation System)**.

> ⚠️ The input to this module must be **preprocessed RegCM data** generated by the **RegCM2HRLDAS Toolchain**.  
> **Raw RegCM model output is not supported directly.**

---

## Input Data Requirements

This module does **not** read raw RegCM output directly.  
All input data must first be processed using the **RegCM → HRLDAS Toolchain**.

The required characteristics of the input datasets are:

- Continuous and gap-free time axis  
- Vertical levels already converted from **sigma levels → pressure levels**  
- Variables pre-selected and converted to correct physical units  
- Spatial domain already subset to the HRLDAS simulation domain  

### Required Variable Groups

| Category    | Variables |
|------------|-----------|
| Atmosphere | Temperature (T), Zonal Wind (U), Meridional Wind (V), Specific Humidity (Q), Geopotential Height (Z) |
| Surface    | Surface Pressure (PSFC), Shortwave Radiation (SWDOWN), Longwave Radiation (LWDOWN), Rainfall Rate (RAINRATE) |
| Soil       | Soil Moisture, Soil Temperature |

### Example Input File Naming Convention
```bash
<YYYYMM>t_u_v_q_z<GCM>_<SCENARIO>pressure_level.nc
<YYYYMM>ssrd_strd_sp_tp<GCM><SCENARIO>_single_layer.nc
<YYYYMM>0100_setup.nc
```
---

## Improvements Over the Original ERA5-Based Script

This module is derived from the original **ERA5 → HRLDAS preprocessing scripts** developed by  
**DOAN Quang Van and XUE Lingbo (University of Tsukuba)**.

It has been substantially extended to support **RegCM-based climate simulations** and long-term climate experiments.

### 1. Full Support for RegCM Workflow

The original scripts were designed specifically for ERA5 reanalysis data.  
This version replaces that logic and instead reads:

- Atmospheric fields processed by the **RegCM2HRLDAS atmospheric module**  
- Surface flux fields processed by the **RegCM2HRLDAS surface module**  
- Soil initialization data prepared by the **RegCM2HRLDAS setup module**

This allows the system to operate directly on **dynamically downscaled climate simulations**, not just reanalysis data.

---

### 2. Support for Climate Model Calendars (CFTime)

The original workflow relied on standard Python `datetime`, which only supports the Gregorian calendar.  
This version introduces **CFTime (`cftime`) support**, enabling correct handling of climate model calendars such as:

- `noleap`  
- `360_day`  
- `proleptic_gregorian`  

This prevents **time drift and timestamp misalignment** when generating forcing data over multi-decade climate simulations.

> **Note:** Although this module can generate LDASIN files using CFTime calendars,  
> the current HRLDAS model itself still expects **Gregorian time** during simulation.

---

### 3. Parallel Processing for Faster LDASIN Generation

The LDASIN generation process has been redesigned to support **multi-core parallel processing**.

Key improvements:

- Workload distributed across time steps  
- Significant reduction in runtime for multi-year simulations  
- Scales efficiently on HPC systems  

This enhancement is especially important when processing long climate projections with hourly forcing data.

---

## Python Libraries and Environment Requirements

This module runs inside the **same Conda environment** created by the RegCM → HRLDAS Toolchain Installer.

Additional Python libraries required for this forcing generator module include:
```bash
pip install numpy pandas xarray netCDF4 scipy cftime
```
### Library Roles

| Library  | Purpose |
|---------|---------|
| numpy   | Numerical array operations |
| pandas  | Time handling and indexing |
| xarray  | Multidimensional NetCDF data processing |
| netCDF4 | NetCDF file I/O backend |
| scipy   | Spatial interpolation (e.g., `RectBivariateSpline`) |
| cftime  | Support for non-Gregorian climate model calendars |

These libraries enable:

- Reading and writing HRLDAS-compatible NetCDF files  
- Handling long climate simulations with non-standard calendars  
- Performing spatial interpolation from RegCM grids to HRLDAS domains  
- Efficient numerical processing for large forcing datasets  

---

## Running the HRLDAS Forcing Generation

The generation of **LDASIN**, **setup**, **LAI**, and **VEGFRA** files is performed using:
```bash
python run_HRLDAS_regcm.py
```
This script is adapted from the original ERA5-based workflow by  
**DOAN Quang Van and XUE Lingbo (University of Tsukuba)**  
and modified to support the **RegCM preprocessing workflow** and long-term climate simulations.

---

### Additional Parameters Introduced in This Version

| Variable    | Description |
|------------|-------------|
| `gcm_name` | Name of the driving Global Climate Model (e.g., CMCC-ESM2) |
| `scenario` | Emission scenario (e.g., ssp245, ssp585) |
| `num_cores`| Number of CPU cores used for parallel LDASIN generation |
| `calendar` | Calendar type of the climate model data (`gregorian`, `noleap`, `360_day`, etc.) |

These parameters allow the script to:

- Organize outputs by GCM and scenario  
- Scale performance on multi-core systems  
- Correctly interpret climate model time axes  

### Example Configuration

```python
gcm_name = "CMCC-ESM2"
scenario = "ssp245"
num_cores = 20
calendar = "gregorian"
```

### Notes and Limitations
Input data must be preprocessed using the RegCM2HRLDAS Toolchain before running this module.
Raw RegCM model outputs are not supported.

This module significantly improves performance by enabling parallel LDASIN generation, which is essential for long-term, high-resolution climate simulations.

Although the module can generate LDASIN files using CFTime calendars (noleap, 360_day, etc.),
the current HRLDAS model itself still expects Gregorian time during simulation runs.

Users working with non-Gregorian climate simulations may need an additional time-conversion step before running HRLDAS.

### Workflow Summary

RegCM Simulation  
        ↓  
RegCM2HRLDAS Toolchain  
        ↓  
HRLDAS Forcing Generator (this module)  
        ↓  
HRLDAS Simulation

